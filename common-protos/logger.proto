syntax = "proto3";

package logger;

// The Logger service definition.
service LoggerService {
  // Retrieves logs with filtering and cursor-based pagination.
  rpc GetLogs (GetLogsRequest) returns (GetLogsResponse);

  // Retrieves user activity logs with filtering and page number-based pagination.
  rpc GetUserActivityLogs (GetUserActivityRequest) returns (GetUserActivityResponse);

  rpc GetUserActivityLogsByLevel (GetUserActivityByLevelRequest) returns (GetUserActivityResponse);
}

message GetUserActivityByLevelRequest {
  string level = 1;         // required: filter by level only
  int32 pageSize = 2;       // number of trace groups per page
  int32 pageNumber = 3;     // starting at 1
  string fromLoggedAt = 4;  // optional ISO string
  string toLoggedAt = 5;    // optional ISO string
}

// The request message containing the log details.
message LogRequest {
  string did = 1;
  string traceId = 2;
  string serviceName = 3;
  string level = 4;
  string message = 5;
  string startTime = 6;
  string endTime = 7;
}


// Request for GetLogs.
message GetLogsRequest {
  string did = 1;           // Optional filter
  int32 pageSize = 2;       // Number of trace groups per page
  string pagingState = 3;   // Cassandra cursor

  // Additional filters
  string traceId = 4;
  string serviceName = 5;
  string level = 6;
  string fromLoggedAt = 7;  // ISO string
  string toLoggedAt = 8;    // ISO string
}

// Represents a single log entry.
message LogRecord {
  string did = 1;
  string traceId = 2;
  string serviceName = 3;
  string level = 4;
  string message = 5;
  string startTime = 6;
  string endTime = 7;
  string loggedAt = 8;
}

// Grouped logs per traceId.
message TraceGroup {
  string traceId = 1;
  repeated LogRecord logs = 2;

  // Optional metadata
  string did = 3;
  string serviceName = 4;
  string firstLoggedAt = 5;
  string lastLoggedAt = 6;
}

// Response for GetLogs.
message GetLogsResponse {
  repeated TraceGroup traceGroups = 1;
  string nextPagingState = 2;
}


// ==========================
// USER ACTIVITY LOGGING API
// ==========================

// Request for GetUserActivityLogs.
message GetUserActivityRequest {
  string did = 1;
  int32 pageSize = 2;
  int32 pageNumber = 3;

  // Filters
  string level = 4;
  string traceId = 5;
  string fromLoggedAt = 6;
  string toLoggedAt = 7;

  // NEW EXTRA FILTERS
  int64 minDuration = 8;        // duration >= this
  int64 maxDuration = 9;        // duration <= this
  string message = 10;          // exact match
  string messageContains = 11;  // substring (in-memory filtered)
}

// One raw user activity log (DB row)
message UserActivityLogRecord {
  string did = 1;
  string traceId = 2;
  string level = 3;
  string message = 4;
  int64 duration = 5;
  string loggedAt = 6;
}

// One logical log = one trace group
message UserActivityLog {
  string did = 1;
  string traceId = 2;
  string level = 3;
  string message = 4;
  int64 duration = 5;
  string loggedAt = 6;

  // All underlying rows in this trace group
  repeated UserActivityLogRecord records = 7;
}

// Response for GetUserActivityLogs.
message GetUserActivityResponse {
  repeated UserActivityLog logs = 1; // Each = 1 trace group
  int32 pageNumber = 2;              // Current page
  int32 totalLogs = 3;               // Total trace groups
}
